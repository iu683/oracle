#!/bin/bash

# ==========================================
# ä¸€é”®ç³»ç»Ÿæ›´æ–° & å¸¸ç”¨ä¾èµ–å®‰è£… & ä¿®å¤ APT æºï¼ˆè·¨å‘è¡Œç‰ˆï¼‰
# ==========================================

# é¢œè‰²å®šä¹‰
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
RESET="\033[0m"

# æ£€æŸ¥æ˜¯å¦ root
if [ "$(id -u)" -ne 0 ]; then
    echo -e "${RED}âŒ è¯·ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬${RESET}"
    exit 1
fi

# =============================
# å„å‘è¡Œç‰ˆä¾èµ–åŒ…åˆ—è¡¨
# =============================
deps_debian=(curl wget git net-tools lsof tar unzip rsync pv sudo netcat-openbsd htop)
deps_rhel=(curl wget git net-tools lsof tar unzip rsync pv sudo nmap-ncat htop)
deps_fedora=(curl wget git net-tools lsof tar unzip rsync pv sudo nmap-ncat htop)
deps_alpine=(curl wget git net-tools lsof tar unzip rsync pv sudo netcat-openbsd htop)

# =============================
# æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
# =============================
check_and_install() {
    local check_cmd="$1"
    local install_cmd="$2"
    shift 2
    local pkgs=("$@")
    local missing=()

    # å…ˆå•ç‹¬æ£€æŸ¥å‘½ä»¤æ˜¯å¦å·²å­˜åœ¨
    if command -v nc >/dev/null 2>&1; then
        echo -e "${GREEN}âœ” å·²å®‰è£…: nc${RESET}"
        pkgs=("${pkgs[@]/netcat-openbsd/}" "${pkgs[@]/nmap-ncat/}")
    fi
    if command -v htop >/dev/null 2>&1; then
        echo -e "${GREEN}âœ” å·²å®‰è£…: htop${RESET}"
        pkgs=("${pkgs[@]/htop/}")
    fi

    # éå†å‰©ä½™ä¾èµ–
    for pkg in "${pkgs[@]}"; do
        [[ -z "$pkg" ]] && continue
        if ! eval "$check_cmd \"$pkg\"" &>/dev/null; then
            missing+=("$pkg")
        else
            echo -e "${GREEN}âœ” å·²å®‰è£…: $pkg${RESET}"
        fi
    done

    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${YELLOW}ğŸ‘‰ å®‰è£…ç¼ºå¤±ä¾èµ–: ${missing[*]}${RESET}"
        eval "$install_cmd \"\${missing[@]}\""
    fi
}

# =============================
# æ¸…ç†é‡å¤ Docker æºï¼ˆä»… Debian/Ubuntuï¼‰
# =============================
fix_duplicate_docker_sources() {
    echo -e "${YELLOW}ğŸ” æ£€æŸ¥é‡å¤ Docker APT æº...${RESET}"
    local docker_sources
    docker_sources=$(grep -rl "download.docker.com" /etc/apt/sources.list.d/ 2>/dev/null || true)
    if [ "$(echo "$docker_sources" | grep -c .)" -gt 1 ]; then
        echo -e "${RED}âš ï¸ æ£€æµ‹åˆ°é‡å¤ Docker æº:${RESET}"
        echo "$docker_sources"
        for f in $docker_sources; do
            if [[ "$f" == *"archive_uri"* ]]; then
                rm -f "$f"
                echo -e "${GREEN}âœ” åˆ é™¤å¤šä½™æº: $f${RESET}"
            fi
        done
    else
        echo -e "${GREEN}âœ” Docker æºæ­£å¸¸${RESET}"
    fi
}

# =============================
# ä¿®å¤ Debian/Ubuntu æºå…¼å®¹æ€§
# =============================
fix_sources_for_version() {
    echo -e "${YELLOW}ğŸ” ä¿®å¤ sources.list å…¼å®¹æ€§...${RESET}"
    local version="$1"
    local files
    files=$(grep -rl "deb" /etc/apt/sources.list /etc/apt/sources.list.d/ 2>/dev/null || true)
    for f in $files; do
        if [[ "$version" == "bullseye" ]]; then
            sed -i -r 's/\bnon-free(-firmware){0,3}\b/non-free/g' "$f"
            sed -i '/bullseye-backports/s/^/##/' "$f"
        fi
    done
    echo -e "${GREEN}âœ” sources.list å·²ä¼˜åŒ–${RESET}"
}

# =============================
# ç³»ç»Ÿæ›´æ–° & ä¾èµ–å®‰è£…
# =============================
update_system() {
    echo -e "${GREEN}ğŸ”„ æ£€æµ‹ç³»ç»Ÿå‘è¡Œç‰ˆå¹¶æ›´æ–°...${RESET}"
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo -e "${YELLOW}ğŸ‘‰ å½“å‰ç³»ç»Ÿ: $PRETTY_NAME${RESET}"

        case "$ID" in
            debian|ubuntu)
                fix_duplicate_docker_sources
                fix_sources_for_version "$VERSION_CODENAME"
                apt update -y
                apt full-upgrade -y
                check_and_install "dpkg -s" "apt install -y" "${deps_debian[@]}"
                ;;
            fedora)
                dnf upgrade --refresh -y
                check_and_install "rpm -q" "dnf install -y" "${deps_fedora[@]}"
                ;;
            centos|rhel)
                yum upgrade -y
                check_and_install "rpm -q" "yum install -y" "${deps_rhel[@]}"
                ;;
            alpine)
                apk update
                apk upgrade --available
                check_and_install "apk info -e" "apk add" "${deps_alpine[@]}"
                ;;
            *)
                echo -e "${RED}âŒ æš‚ä¸æ”¯æŒçš„ Linux å‘è¡Œç‰ˆ: $ID${RESET}"
                return 1
                ;;
        esac
    else
        echo -e "${RED}âŒ æ— æ³•æ£€æµ‹ç³»ç»Ÿå‘è¡Œç‰ˆ (/etc/os-release ä¸å­˜åœ¨)${RESET}"
        return 1
    fi

    echo -e "${GREEN}âœ… ç³»ç»Ÿæ›´æ–°å’Œä¾èµ–å®‰è£…å®Œæˆï¼${RESET}"
}

# =============================
# æ‰§è¡Œ
# =============================
clear
update_system
echo -e "${GREEN}âœ… è„šæœ¬æ‰§è¡Œå®Œæˆï¼${RESET}"
